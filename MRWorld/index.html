<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebXR AR — простой demo</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Inter,Segoe UI,Arial}
    #ui{position:fixed;left:12px;top:12px;z-index:3;max-width:360px;background:rgba(0,0,0,0.4);padding:10px;border-radius:8px}
    button, a.button{background:#1e90ff;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .small{font-size:13px;opacity:0.85}
    #fallbackNotice{margin-top:8px;color:#ffcc66}
    canvas{display:block}
    #msg{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,0.45);padding:8px;border-radius:6px;font-size:13px}
  </style>
</head>
<body>
  <div id="ui">
    <strong>WebXR AR — простой demo для 3D‑очков / телефонов</strong>
    <div class="small" style="margin-top:8px">Поставьте объект на плоскость пальцем (или контроллером). Для реального AR требуется поддержка WebXR AR (Chrome+ARCore на Android).</div>
    <div id="fallbackNotice" class="small"></div>
    <div style="margin-top:8px">
      <!-- ARButton (создаётся скриптом) -->
      <span id="arButtonContainer"></span>
      <button id="previewBtn" style="margin-left:8px">3D‑preview (fallback)</button>
    </div>
  </div>

  <div id="msg">Нажмите на HUD или используйте контроллер, чтобы разместить модель.</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { ARButton } from 'https://unpkg.com/three@0.152.2/examples/jsm/webxr/ARButton.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js';

    let camera, scene, renderer;
    let controller;
    let reticle;
    let hitTestSource = null;
    let hitTestSourceRequested = false;
    let placedMesh;

    initRenderer();

    // Проверяем поддержку immersive-ar и инициализируем соответствующий режим
    if (navigator.xr) {
      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        if (supported) {
          initAR();
          document.getElementById('fallbackNotice').textContent = 'Устройство поддерживает WebXR AR.';
        } else {
          document.getElementById('fallbackNotice').textContent = 'WebXR AR не поддерживается на этом устройстве — открыт 3D‑preview.';
          initPreview();
        }
      }).catch(()=>{ document.getElementById('fallbackNotice').textContent = 'Проверка WebXR не удалась — открыт 3D‑preview.'; initPreview(); });
    } else {
      document.getElementById('fallbackNotice').textContent = 'WebXR отсутствует — открыт 3D‑preview.';
      initPreview();
    }

    // Кнопка preview (ручной запуск preview если пользователь захочет)
    document.getElementById('previewBtn').addEventListener('click', ()=>{ initPreview(); });

    function initRenderer(){
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.domElement.style.position = 'absolute';
      renderer.domElement.style.top = 0;
      renderer.domElement.style.left = 0;
      renderer.xr.enabled = true; // включаем XR (без сессии это безопасно)
      document.body.appendChild(renderer.domElement);
      window.addEventListener('resize', onWindowResize);

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
      scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1));

      // плейсхолдер модели (простой куб) — будет видим после размещения
      const geo = new THREE.BoxGeometry(0.15,0.15,0.15);
      const mat = new THREE.MeshStandardMaterial({ color: 0xff5533, metalness:0.2, roughness:0.6 });
      placedMesh = new THREE.Mesh(geo, mat);
      placedMesh.visible = false;
      scene.add(placedMesh);

      // reticle — индикатор места для размещения
      const ring = new THREE.RingGeometry(0.07, 0.09, 32).rotateX(-Math.PI/2);
      reticle = new THREE.Mesh(ring, new THREE.MeshBasicMaterial({ color: 0x00ff00 }));
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      // controller для select (тап/контроллер)
      controller = renderer.xr.getController(0);
      controller.addEventListener('select', onSelect);
      scene.add(controller);
    }

    function initAR(){
      // разместим ARButton внутрь HUD
      const container = document.getElementById('arButtonContainer');
      container.innerHTML = '';
      container.appendChild( ARButton.createButton( renderer, { requiredFeatures: ['hit-test'] } ) );
      renderer.setAnimationLoop( render );
    }

    // Простой non-AR preview (OrbitControls) — для десктопа/gh-pages просмотра
    let previewStarted = false;
    function initPreview(){
      if (previewStarted) return;
      previewStarted = true;
      // добавим небольшой свет
      scene.add(new THREE.DirectionalLight(0xffffff, 0.6));
      scene.add(new THREE.AmbientLight(0x888888, 0.6));
      placedMesh.position.set(0, 0, -0.6);
      placedMesh.visible = true;

      // OrbitControls для мыши
      const controls = new OrbitControls(camera, renderer.domElement);
      camera.position.set(0, 0.2, 0.6);
      controls.target.set(0,0,0);
      controls.update();

      renderer.setAnimationLoop(()=>{
        placedMesh.rotation.y += 0.01;
        renderer.render(scene, camera);
      });
    }

    function onSelect(){
      if (reticle.visible) {
        placedMesh.position.setFromMatrixPosition(reticle.matrix);
        const euler = new THREE.Euler(0, Math.random()*Math.PI*2, 0);
        placedMesh.setRotationFromEuler(euler);
        placedMesh.visible = true;
      }
    }

    function onWindowResize(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // основной рендер + hit test
    function render(timestamp, frame){
      if (frame) {
        const referenceSpace = renderer.xr.getReferenceSpace();
        const session = renderer.xr.getSession();

        if (hitTestSourceRequested === false) {
          session.requestReferenceSpace('viewer').then((refSpace) => {
            session.requestHitTestSource({ space: refSpace }).then((source) => { hitTestSource = source; });
          });

          session.addEventListener('end', ()=>{
            hitTestSourceRequested = false;
            hitTestSource = null;
          });

          hitTestSourceRequested = true;
        }

        if (hitTestSource) {
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          if (hitTestResults.length) {
            const hit = hitTestResults[0];
            const pose = hit.getPose(referenceSpace);
            reticle.visible = true;
            reticle.matrix.fromArray(pose.transform.matrix);
          } else {
            reticle.visible = false;
          }
        }
      }

      // лёгкая анимация модели (если размещена)
      if (placedMesh.visible) placedMesh.rotation.y += 0.01;
      renderer.render(scene, camera);
    }

  </script>
</body>
</html>